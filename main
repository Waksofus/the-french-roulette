#Bibliotheque
import time
import random
import pygame
from perso import Perso
from fusil import Fusil
from couleurs import BLEU, ROUGE, FOND_PARIS, FROMAGE, BAGUETTE, BERET, TEXTE, PV_BARRE, PV_FOND

#Initialisation de Pygame
pygame.init()

#Configurations de la fenetre
LARGEUR, HAUTEUR = 800, 600
screen = pygame.display.set_mode((LARGEUR, HAUTEUR))
pygame.display.set_caption("The French Roulette")

#Polices
font = pygame.font.Font(None, 36)
font_petit = pygame.font.Font(None, 24)

#Fonction pour dessiner le fond et les elements du jeu
def dessiner_fond():
    #Fond Tour Eiffel
    screen.fill(FOND_PARIS)
    #screen.blit(tour_eiffel, (200, 1))  #Position a ajuster selon image
    pygame.draw.rect(screen, BLEU, (0, 0, LARGEUR, HAUTEUR // 6))  #Bande bleue en haut (bleu France)

def dessiner_perso(perso, x, y):
    #Affiche les perso avec leur beret (et un petit effet si mort)
    #screen.blit(beret_image, (x, y))
    texte_nom = font.render(perso.nom, True, TEXTE)
    screen.blit(texte_nom, (x - 20, y + 50))  #Affiche le nom du personnage

def dessiner_pv(perso, x, y):
    #Barre de PV
    pygame.draw.rect(screen, PV_FOND, (x, y, 200, 20))
    pygame.draw.rect(screen, PV_BARRE, (x, y, 200 * (perso.pv / 3), 20))  #Ratio PV restant

#Images (les images a ajouter dans le dossier assets si tu veux les personnaliser)
#tour_eiffel = pygame.image.load('Desktop/Projet NSI/assets/tour_eiffel.png')  #Image a telecharger/ajouter
#baguette_image = pygame.image.load('Desktop/Projet NSI/assets/baguette.png')
#beret_image = pygame.image.load('Desktop/Projet NSI/assets/beret.png')

#Classes initialisees
joueur = Perso("Joueur")
bot = Perso("Bot",True)
fusil = Fusil()

#Boucle principale du jeu
joueur_avec_fusil=joueur
running = True
while running:
    #evenements
    for event in pygame.event.get():
        if event.type == pygame.QUIT or not bot.est_vivant() or not joueur.est_vivant():
            running = False

        if event.type == pygame.MOUSEBUTTONDOWN:
            if event.button == 1:  #Clic gauche = tirer sur soi
                joueur_cible=joueur
            if event.button == 3:  #Clic droit = tirer sur bot
                joueur_cible=bot
            pv_perdu = joueur_avec_fusil.action_tirer(joueur_cible, fusil.tirer())
            if pv_perdu:
                texte_info = font_petit.render(f"{joueur_cible.nom} a pris une balle !", True, TEXTE)
                screen.blit(texte_info, (250, 500))
                pygame.display.flip()
                time.sleep(1)
            else:
                texte_info = font_petit.render("Balle a blanc ! Rien n'est arrive.", True, TEXTE)
                screen.blit(texte_info, (250, 500))
                pygame.display.flip()
                time.sleep(1)
            if joueur_cible.vient_de_perdre_pv or joueur_avec_fusil!=joueur_cible: #Le joueur vient de toucher (lui ou le bot) ou tirer a blanc sur l'autre => on change de joueur
                joueur_avec_fusil=(joueur if joueur_avec_fusil.is_bot else bot)
                dessiner_pv(joueur, 100, 250)
                dessiner_pv(bot, 500, 250)
                pygame.display.flip()
                while joueur_avec_fusil.is_bot and bot.est_vivant() and joueur.est_vivant(): #Le bot rejoue tant que c'est a lui (s'il se tire a blanc dessus) et si tout le monde est en vie
                    #STRAT DU BOT 
                    time.sleep(3)
                    if joueur_avec_fusil.pv == 1: #Sâ€™il est en danger, le bot tire uniquement sur le joueur
                        joueur_cible = joueur
                    else: #50% de chance de se tirer ou tirer l'autre
                        joueur_cible = bot if random.random() > 0.5 else joueur
                    pv_perdu = joueur_avec_fusil.action_tirer(joueur_cible, fusil.tirer())
                    if pv_perdu:
                        texte_info = font_petit.render(f"{joueur_cible.nom} a pris une balle !", True, TEXTE)
                        screen.blit(texte_info, (250, 500))
                        pygame.display.flip()
                        time.sleep(1)
                    else:
                        texte_info = font_petit.render("Balle a blanc ! Rien n'est arrive.", True, TEXTE)
                        screen.blit(texte_info, (250, 500))
                        pygame.display.flip()
                        time.sleep(1)
                    if joueur_cible.vient_de_perdre_pv or joueur_avec_fusil!=joueur_cible: #Le bot vient de toucher (lui ou le joueur) ou tirer a blanc sur l'autre => on change de joueur
                        joueur_avec_fusil=joueur

    #Dessiner fond
    dessiner_fond()

    #Dessiner personnages
    dessiner_perso(joueur, 100, 300)
    dessiner_perso(bot, 500, 300)

    #Dessiner PV
    dessiner_pv(joueur, 100, 250)
    dessiner_pv(bot, 500, 250)

    #Actualiser l'ecran
    pygame.display.flip()
    pygame.time.Clock().tick(60)

time.sleep(2)
pygame.quit()
